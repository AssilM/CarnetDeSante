PLAN D'IMPL√âMENTATION SYST√àME EMAIL - CARNET DE SANT√â VIRTUEL
================================================================

üìã PHASE 1: PR√âPARATION ET CONFIGURATION DE BASE
=================================================

T√ÇCHE 1.1: Installation des d√©pendances
----------------------------------------
Description: Installer les packages n√©cessaires pour l'envoi d'emails
Fichiers modifi√©s: backend/package.json
D√©pendances: AUCUNE (premi√®re t√¢che)
Commandes:
  cd backend
  npm install nodemailer handlebars
  npm install --save-dev @types/nodemailer

T√ÇCHE 1.2: Configuration des variables d'environnement
------------------------------------------------------
Description: Ajouter les variables d'environnement pour l'email
Fichiers modifi√©s: backend/.env
D√©pendances: T√ÇCHE 1.1
Variables √† ajouter:
  # Email Configuration
  EMAIL_HOST=smtp.gmail.com
  EMAIL_PORT=587
  EMAIL_USER=votre-email@gmail.com
  EMAIL_PASS=votre-mot-de-passe-app
  EMAIL_FROM=Carnet de Sant√© <votre-email@gmail.com>
  FRONTEND_URL=http://localhost:5173
  
  # OTP Configuration
  OTP_EXPIRY_MINUTES=10
  JWT_EMAIL_SECRET=votre-secret-jwt-email

T√ÇCHE 1.3: Cr√©ation de la structure des dossiers
-------------------------------------------------
Description: Cr√©er l'arborescence pour le syst√®me email
D√©pendances: T√ÇCHE 1.1
Dossiers √† cr√©er:
  backend/src/email/
  backend/src/email/templates/
  backend/src/utils/ (si n'existe pas)

üìã PHASE 2: INFRASTRUCTURE EMAIL
=================================

T√ÇCHE 2.1: Configuration du transporteur email
----------------------------------------------
Description: Cr√©er la configuration de base pour Nodemailer
Fichiers cr√©√©s: backend/src/email/email.config.js
D√©pendances: T√ÇCHE 1.2
Contenu:
  - Configuration du transporteur SMTP
  - Variables de configuration email
  - Fonction de test de connexion

T√ÇCHE 2.2: Cr√©ation des templates HTML de base
-----------------------------------------------
Description: Cr√©er les templates Handlebars pour les emails
Fichiers cr√©√©s: 
  backend/src/email/templates/verification.html
  backend/src/email/templates/otp.html
  backend/src/email/templates/welcome.html
  backend/src/email/templates/reset-password.html
D√©pendances: T√ÇCHE 1.3
Fonctionnalit√©s:
  - Template de v√©rification email
  - Template OTP avec code
  - Template de bienvenue
  - Template de r√©initialisation mot de passe

T√ÇCHE 2.3: Service de gestion des templates
-------------------------------------------
Description: Cr√©er le service pour compiler et rendre les templates
Fichiers cr√©√©s: backend/src/email/email.templates.js
D√©pendances: T√ÇCHE 2.2
Fonctionnalit√©s:
  - Compilation des templates Handlebars
  - Rendu avec donn√©es dynamiques
  - Gestion des erreurs de template

üìã PHASE 3: SERVICE EMAIL PRINCIPAL
====================================

T√ÇCHE 3.1: Cr√©ation du service email principal
-----------------------------------------------
Description: Cr√©er le service qui g√®re tous les envois d'emails
Fichiers cr√©√©s: backend/src/email/email.service.js
D√©pendances: T√ÇCHE 2.1, T√ÇCHE 2.3
Fonctionnalit√©s:
  - sendVerificationEmail()
  - sendOTPEmail()
  - sendWelcomeEmail()
  - sendPasswordResetEmail()
  - sendAppointmentNotification()

T√ÇCHE 3.2: Utilitaires pour g√©n√©ration de tokens
------------------------------------------------
Description: Ajouter les fonctions pour g√©n√©rer OTP et tokens email
Fichiers modifi√©s: backend/src/utils/auth.utils.js
D√©pendances: T√ÇCHE 3.1
Fonctionnalit√©s √† ajouter:
  - generateOTP() - G√©n√®re un code √† 6 chiffres
  - generateEmailToken() - Token JWT pour v√©rification email
  - validateOTP() - Validation du code OTP

üìã PHASE 4: MODIFICATIONS BASE DE DONN√âES
==========================================

T√ÇCHE 4.1: Cr√©ation de la table OTP
------------------------------------
Description: Cr√©er la table pour stocker les codes OTP
Fichiers cr√©√©s: backend/src/data/createOTPTable.js
D√©pendances: T√ÇCHE 3.2
SQL √† ex√©cuter:
  - Table otp_codes
  - Index pour performance
  - Fonction de nettoyage automatique

T√ÇCHE 4.2: Ajout du champ email_verified
----------------------------------------
Description: Ajouter le champ de v√©rification email √† la table utilisateur
Fichiers modifi√©s: backend/src/data/createTables.js
D√©pendances: T√ÇCHE 4.1
SQL √† ajouter:
  - ALTER TABLE utilisateur ADD COLUMN email_verified BOOLEAN DEFAULT FALSE
  - ALTER TABLE utilisateur ADD COLUMN email_verified_at TIMESTAMP

T√ÇCHE 4.3: Script de migration de base de donn√©es
-------------------------------------------------
Description: Cr√©er un script pour appliquer les modifications DB
Fichiers cr√©√©s: backend/src/data/migrateEmailSystem.js
D√©pendances: T√ÇCHE 4.1, T√ÇCHE 4.2
Fonctionnalit√©s:
  - Ex√©cution des scripts SQL
  - V√©rification de la migration
  - Rollback en cas d'erreur

üìã PHASE 5: MODIFICATIONS AUTHENTIFICATION
===========================================

T√ÇCHE 5.1: Modification du repository d'authentification
-------------------------------------------------------
Description: Ajouter les fonctions pour g√©rer OTP et v√©rification email
Fichiers modifi√©s: backend/src/auth/auth.repository.js
D√©pendances: T√ÇCHE 4.3
Fonctionnalit√©s √† ajouter:
  - storeOTP()
  - verifyOTP()
  - deleteOTP()
  - updateEmailVerified()
  - findUserByEmailToken()

T√ÇCHE 5.2: Modification du service d'authentification
----------------------------------------------------
Description: Int√©grer l'envoi d'emails dans les processus d'auth
Fichiers modifi√©s: backend/src/auth/auth.service.js
D√©pendances: T√ÇCHE 3.1, T√ÇCHE 5.1
Modifications:
  - createUser() - Ajouter envoi email v√©rification
  - authenticateUser() - Option OTP
  - authenticateUserWithOTP() - Nouvelle fonction
  - verifyEmail() - V√©rification email

T√ÇCHE 5.3: Modification du contr√¥leur d'authentification
--------------------------------------------------------
Description: Ajouter les nouvelles routes pour OTP et v√©rification
Fichiers modifi√©s: backend/src/auth/auth.controller.js
D√©pendances: T√ÇCHE 5.2
Nouvelles fonctions:
  - signinWithOTP()
  - verifyOTP()
  - verifyEmail()
  - resendVerificationEmail()

ÔøΩÔøΩ PHASE 6: NOUVELLES ROUTES
=============================

T√ÇCHE 6.1: Ajout des nouvelles routes d'authentification
--------------------------------------------------------
Description: Cr√©er les routes pour OTP et v√©rification email
Fichiers modifi√©s: backend/src/routes/auth.routes.js
D√©pendances: T√ÇCHE 5.3
Nouvelles routes:
  - POST /auth/signin/otp
  - POST /auth/verify-otp
  - POST /auth/verify-email
  - POST /auth/resend-verification

T√ÇCHE 6.2: Middleware de validation pour OTP
---------------------------------------------
Description: Cr√©er la validation pour les nouvelles routes
Fichiers modifi√©s: backend/src/middlewares/auth.validation.middleware.js
D√©pendances: T√ÇCHE 6.1
Nouvelles validations:
  - validateOTPData()
  - validateEmailVerificationData()

üìã PHASE 7: INT√âGRATION NOTIFICATIONS
======================================

T√ÇCHE 7.1: Modification du service de notifications
--------------------------------------------------
Description: Int√©grer l'envoi d'emails dans les notifications importantes
Fichiers modifi√©s: backend/src/notification/notification.service.js
D√©pendances: T√ÇCHE 3.1
Modifications:
  - createNotificationWithEmail()
  - sendEmailForImportantNotifications()

T√ÇCHE 7.2: Modification du service de rendez-vous
-------------------------------------------------
Description: Ajouter l'envoi d'emails pour les rendez-vous
Fichiers modifi√©s: backend/src/appointment/rendezvous.service.js
D√©pendances: T√ÇCHE 7.1
Fonctionnalit√©s:
  - Email de confirmation de RDV
  - Email de rappel de RDV
  - Email d'annulation de RDV

üìã PHASE 8: TESTS ET VALIDATION
=================================

T√ÇCHE 8.1: Tests de base du service email
------------------------------------------
Description: Cr√©er des tests pour v√©rifier l'envoi d'emails
Fichiers cr√©√©s: backend/test-email-service.js
D√©pendances: T√ÇCHE 3.1
Tests √† effectuer:
  - Test de connexion SMTP
  - Test d'envoi d'email simple
  - Test de templates
  - Test de g√©n√©ration OTP

T√ÇCHE 8.2: Tests d'int√©gration authentification
------------------------------------------------
Description: Tester le processus complet d'inscription avec email
Fichiers cr√©√©s: backend/test-auth-email.js
D√©pendances: T√ÇCHE 6.1
Tests √† effectuer:
  - Inscription avec envoi email
  - Connexion avec OTP
  - V√©rification email
  - R√©initialisation mot de passe

T√ÇCHE 8.3: Tests des notifications par email
--------------------------------------------
Description: Tester l'envoi d'emails pour les notifications
Fichiers cr√©√©s: backend/test-notification-email.js
D√©pendances: T√ÇCHE 7.2
Tests √† effectuer:
  - Notification de RDV cr√©√©
  - Notification de RDV confirm√©
  - Notification de document partag√©

üìã PHASE 9: DOCUMENTATION ET CONFIGURATION
===========================================

T√ÇCHE 9.1: Documentation du syst√®me email
------------------------------------------
Description: Cr√©er la documentation pour l'utilisation du syst√®me
Fichiers cr√©√©s: backend/src/email/README.md
D√©pendances: T√ÇCHE 8.3
Contenu:
  - Configuration SMTP
  - Utilisation du service email
  - Templates disponibles
  - Exemples d'utilisation

T√ÇCHE 9.2: Script de configuration automatique
-----------------------------------------------
Description: Cr√©er un script pour configurer automatiquement l'email
Fichiers cr√©√©s: backend/setup-email.js
D√©pendances: T√ÇCHE 9.1
Fonctionnalit√©s:
  - V√©rification des variables d'environnement
  - Test de connexion SMTP
  - Cr√©ation des tables n√©cessaires
  - Validation de la configuration

üìã PHASE 10: D√âPLOIEMENT ET MONITORING
=======================================

T√ÇCHE 10.1: Configuration pour la production
--------------------------------------------
Description: Adapter la configuration pour l'environnement de production
Fichiers modifi√©s: backend/src/email/email.config.js
D√©pendances: T√ÇCHE 9.2
Modifications:
  - Configuration SMTP de production
  - Gestion des erreurs robuste
  - Logging des envois d'emails

T√ÇCHE 10.2: Monitoring et logging
----------------------------------
Description: Ajouter le monitoring des envois d'emails
Fichiers modifi√©s: backend/src/email/email.service.js
D√©pendances: T√ÇCHE 10.1
Fonctionnalit√©s:
  - Logging des envois r√©ussis/√©chou√©s
  - M√©triques de performance
  - Alertes en cas d'√©chec

================================================================
R√âSUM√â DES D√âPENDANCES CRITIQUES:
================================================================

D√âPENDANCES OBLIGATOIRES (doivent √™tre faites dans cet ordre):
1. T√ÇCHE 1.1 ‚Üí T√ÇCHE 1.2 ‚Üí T√ÇCHE 1.3
2. T√ÇCHE 2.1 ‚Üí T√ÇCHE 2.2 ‚Üí T√ÇCHE 2.3
3. T√ÇCHE 3.1 ‚Üí T√ÇCHE 3.2
4. T√ÇCHE 4.1 ‚Üí T√ÇCHE 4.2 ‚Üí T√ÇCHE 4.3
5. T√ÇCHE 5.1 ‚Üí T√ÇCHE 5.2 ‚Üí T√ÇCHE 5.3
6. T√ÇCHE 6.1 ‚Üí T√ÇCHE 6.2
7. T√ÇCHE 7.1 ‚Üí T√ÇCHE 7.2
8. T√ÇCHE 8.1 ‚Üí T√ÇCHE 8.2 ‚Üí T√ÇCHE 8.3
9. T√ÇCHE 9.1 ‚Üí T√ÇCHE 9.2
10. T√ÇCHE 10.1 ‚Üí T√ÇCHE 10.2

D√âPENDANCES CROIS√âES:
- T√ÇCHE 3.1 d√©pend de T√ÇCHE 2.1 ET T√ÇCHE 2.3
- T√ÇCHE 5.2 d√©pend de T√ÇCHE 3.1 ET T√ÇCHE 5.1
- T√ÇCHE 7.1 d√©pend de T√ÇCHE 3.1
- T√ÇCHE 7.2 d√©pend de T√ÇCHE 7.1

ESTIMATION TEMPS TOTAL: 2-3 jours de d√©veloppement
PHASES CRITIQUES: 1, 2, 4, 5 (doivent √™tre faites en premier)
PHASES OPTIONNELLES: 9, 10 (peuvent √™tre faites plus tard)
