# ğŸ¥ Roadmap - SystÃ¨me de Partage Documentaire

## ğŸ“‹ Vue d'ensemble

Extension du systÃ¨me de gestion documentaire avec contrÃ´le d'accÃ¨s granulaire et suivi des relations patient-mÃ©decin.

**Logique de sÃ©curitÃ© :** Partage uniquement avec des mÃ©decins consultÃ©s (ayant eu au moins un RDV avec le patient)

---

## Backend - TÃ¢ches principales

### 1. Module ACL (Access Control List)
**Dossier :** backend/src/acl/

**Fichiers Ã  crÃ©er :**
- acl.repository.js - AccÃ¨s aux tables document_permission et patient_doctor
- acl.service.js - Logique mÃ©tier du partage et des permissions
- acl.controller.js - Endpoints REST pour le partage
- index.js - Routes du module ACL

**Sous-tÃ¢ches du Repository :**
- getDocumentPermissions(documentId) - RÃ©cupÃ©rer toutes les permissions d'un document
- getUserDocuments(userId) - RÃ©cupÃ©rer les documents accessibles Ã  un utilisateur
- createDocumentPermission(documentId, userId, role) - CrÃ©er une permission
- deleteDocumentPermission(documentId, userId) - Supprimer une permission
- getFollowedDoctors(patientId) - RÃ©cupÃ©rer les mÃ©decins suivis par un patient
- getFollowedPatients(doctorId) - RÃ©cupÃ©rer les patients suivis par un mÃ©decin
- createFollowRelationship(patientId, doctorId) - CrÃ©er un lien de suivi
- removeFollowRelationship(patientId, doctorId) - Supprimer un lien de suivi
- searchPatientByIdentity(nom, prenom, telephone) - Rechercher un patient par identitÃ©

**Sous-tÃ¢ches du Service :**
- checkDocumentPermission(userId, documentId, requiredRole) - VÃ©rifier les permissions
- grantDocumentPermission(documentId, userId, role) - Accorder une permission
- revokeDocumentPermission(documentId, userId) - RÃ©voquer une permission
- getAvailableDoctorsForPatient(patientId) - Lister les mÃ©decins disponibles pour le partage
- getSharedDocumentsForUser(userId) - Lister les documents partagÃ©s d'un utilisateur
- followPatientByIdentity(doctorId, nom, prenom, telephone) - Permettre Ã  un mÃ©decin de suivre n'importe quel patient via identitÃ©

**Sous-tÃ¢ches du Controller :**
- shareDocument(req, res) - Partager un document avec un mÃ©decin
- revokeDocument(req, res) - RÃ©voquer le partage d'un document
- getSharedDocuments(req, res) - Lister les documents partagÃ©s
- getAvailableDoctors(req, res) - Lister les mÃ©decins disponibles pour le partage
- followPatient(req, res) - Suivre un patient via nom, prÃ©nom, tÃ©lÃ©phone

### 2. Modification du Module Patient
**Dossier :** backend/src/patient/

- Ajouter getPatientFollowedDoctors(patientId) dans patient.service.js
- Ajouter getPatientDocuments(patientId) dans patient.service.js
- Ajouter getFollowedDoctors(req, res) dans patient.controller.js
- Ajouter getPatientDocuments(req, res) dans patient.controller.js

### 3. Modification du Module Doctor
**Dossier :** backend/src/doctor/

- Ajouter getDoctorFollowedPatients(doctorId) dans medecin.service.js
- Ajouter getDoctorSharedDocuments(doctorId) dans medecin.service.js
- Ajouter getFollowedPatients(req, res) dans medecin.controller.js
- Ajouter getSharedDocuments(req, res) dans medecin.controller.js

### 4. Modification du Module Appointment
**Dossier :** backend/src/appointment/

- Ajouter createFollowRelationshipAfterAppointment(appointmentId) dans rendezvous.service.js
- Modifier updateRendezVous pour crÃ©er automatiquement le lien de suivi quand le statut passe Ã  "terminÃ©"

### 5. Middleware de VÃ©rification des Permissions
**Dossier :** backend/src/middlewares/

- checkDocumentAccess(req, res, next) - VÃ©rifier l'accÃ¨s Ã  un document
- validateDocumentOwnership(req, res, next) - Valider la propriÃ©tÃ© du document

### 6. IntÃ©gration dans les Routes
**Dossier :** backend/src/routes/

- Ajouter les routes ACL : app.use('/api/acl', aclRoutes)

---

## Frontend - TÃ¢ches principales

### 1. Service API de Partage
frontend/src/services/api/aclService.js
- shareDocument(documentId, doctorId, permission)
- revokeDocument(documentId, doctorId)
- getSharedDocuments()
- getAvailableDoctors()
- followPatient(nom, prenom, telephone)

### 2. Composant de Partage de Documents
frontend/src/components/patient/documents/ShareDocumentModal.jsx
- ShareDocumentModal
- DoctorSelectionList
- PermissionLevelSelector
- ShareConfirmation

### 3. Composant de Gestion des Permissions
frontend/src/components/patient/documents/DocumentPermissions.jsx
- DocumentPermissionsList
- RevokePermissionButton
- PermissionStatusBadge

### 4. Context pour le Partage
frontend/src/context/ShareContext.jsx
- ShareProvider
- useShare
- refreshSharedDocuments

### 5. IntÃ©gration dans les Pages Existantes
- Ajouter bouton "Partager" sur chaque document (Documents.jsx)
- Ajouter section "Documents partagÃ©s" (Documents.jsx)
- Ajouter section des permissions du document (DocumentDetails.jsx)
- Ajouter boutons de gestion des permissions (DocumentDetails.jsx)
- Ajouter section "Documents partagÃ©s par mes patients" (HomeDoctor.jsx)
- Ajouter navigation vers les documents partagÃ©s (HomeDoctor.jsx)

---

## Logique MÃ©tier

### Conditions de Partage
- Patient peut partager uniquement avec des mÃ©decins consultÃ©s
- MÃ©decin peut partager ses documents avec ses patients suivis
- MÃ©decin peut suivre n'importe quel patient via nom, prÃ©nom, tÃ©lÃ©phone
- Niveaux de permission : owner, author, shared

### CrÃ©ation Automatique des Permissions
- Patient upload â†’ owner uniquement
- MÃ©decin upload â†’ owner + author
- Patient peut rÃ©voquer seulement les permissions shared

### Suivi Patient-MÃ©decin
- Lien crÃ©Ã© automatiquement quand un RDV est marquÃ© comme "terminÃ©"
- MÃ©decin peut suivre un patient manuellement via identitÃ© (nom, prÃ©nom, tÃ©lÃ©phone)
- Permet au mÃ©decin de voir les documents partagÃ©s par le patient
- Patient peut supprimer le lien de suivi Ã  tout moment 

---

## ğŸ“š Description dÃ©taillÃ©e de la base de donnÃ©es (ACL & Suivi Patient-MÃ©decin)

### 1. Table `utilisateur`
- **id** (SERIAL, PK)
- **email** (VARCHAR, unique, not null)
- **password** (VARCHAR, not null)
- **nom** (VARCHAR, not null)
- **prenom** (VARCHAR, not null)
- **tel_indicatif** (VARCHAR)
- **tel_numero** (VARCHAR)
- **date_naissance** (DATE)
- **sexe** (VARCHAR)
- **adresse** (VARCHAR)
- **code_postal** (VARCHAR)
- **ville** (VARCHAR)
- **role** (VARCHAR, not null, 'patient' | 'medecin' | 'admin')
- **created_at** (TIMESTAMP)
- **updated_at** (TIMESTAMP)

> **RÃ´le** : Table centrale pour tous les utilisateurs (patients, mÃ©decins, admins).

### 2. Table `patient`
- **utilisateur_id** (INTEGER, PK, FK â†’ utilisateur.id)
- **groupe_sanguin** (VARCHAR)
- **taille** (INTEGER)
- **poids** (INTEGER)
- **updated_at** (TIMESTAMP)

> **RÃ´le** : Extension des infos spÃ©cifiques au patient.

### 3. Table `medecin`
- **utilisateur_id** (INTEGER, PK, FK â†’ utilisateur.id)
- **specialite** (VARCHAR)
- **description** (TEXT)
- **updated_at** (TIMESTAMP)

> **RÃ´le** : Extension des infos spÃ©cifiques au mÃ©decin.

### 4. Table `patient_doctor` (Suivi patient-mÃ©decin)
- **patient_id** (INTEGER, FK â†’ patient.utilisateur_id)
- **doctor_id** (INTEGER, FK â†’ medecin.utilisateur_id)
- **status** (VARCHAR, dÃ©faut 'actif')
- **created_at** (TIMESTAMP)
- **PRIMARY KEY** (patient_id, doctor_id)

> **RÃ´le** : Lien de suivi entre un patient et un mÃ©decin. CrÃ©Ã© automatiquement aprÃ¨s un RDV terminÃ© ou manuellement par le mÃ©decin (via identitÃ© patient). Permet de lister les mÃ©decins suivis par un patient et inversement.

### 5. Table `document`
- **id** (SERIAL, PK)
- **patient_id** (INTEGER, FK â†’ patient.utilisateur_id, not null)
- **medecin_id** (INTEGER, FK â†’ medecin.utilisateur_id, nullable)
- **uploader_id** (INTEGER, FK â†’ utilisateur.id, nullable)
- **type_id** (INTEGER, FK â†’ document_type.id, nullable)
- **titre** (VARCHAR, not null)
- **nom_fichier** (VARCHAR, not null)
- **chemin_fichier** (VARCHAR, not null)
- **type_mime** (VARCHAR, not null)
- **taille_fichier** (INTEGER, not null)
- **date_creation** (DATE, dÃ©faut CURRENT_DATE)
- **description** (TEXT)
- **created_at** (TIMESTAMP)
- **updated_at** (TIMESTAMP)

> **RÃ´le** : Stocke les documents mÃ©dicaux, leur propriÃ©taire (patient), lâ€™uploader (patient ou mÃ©decin), et le type de document.

### 6. Table `document_type`
- **id** (SERIAL, PK)
- **code** (VARCHAR, unique, not null)
- **label** (VARCHAR, not null)
- **created_at** (TIMESTAMP)

> **RÃ´le** : RÃ©fÃ©rence les types de documents (ordonnance, analyse, etc.).

### 7. Table `document_permission` (ACL documentaire)
- **document_id** (INTEGER, FK â†’ document.id)
- **user_id** (INTEGER, FK â†’ utilisateur.id)
- **role** (ENUM doc_role: 'owner', 'author', 'shared')
- **granted_at** (TIMESTAMP, dÃ©faut CURRENT_TIMESTAMP)
- **expires_at** (TIMESTAMP, nullable)
- **PRIMARY KEY** (document_id, user_id)

> **RÃ´le** : GÃ¨re les droits dâ€™accÃ¨s Ã  chaque document pour chaque utilisateur (patient, mÃ©decin). Permet de savoir qui a accÃ¨s Ã  quoi et avec quel niveau de permission.

### 8. Table `rendez_vous`
- **id** (SERIAL, PK)
- **patient_id** (INTEGER, FK â†’ patient.utilisateur_id)
- **medecin_id** (INTEGER, FK â†’ medecin.utilisateur_id)
- **date** (DATE, not null)
- **heure** (TIME, not null)
- **duree** (INTEGER, dÃ©faut 30)
- **statut** (VARCHAR, 'planifiÃ©', 'confirmÃ©', 'annulÃ©', 'en_cours', 'terminÃ©')
- ... (autres champs)

> **RÃ´le** : Permet de crÃ©er automatiquement un lien de suivi (patient_doctor) quand un RDV est terminÃ©.

### 9. Table `specialite`
- **id** (SERIAL, PK)
- **nom** (VARCHAR, unique, not null)
- **created_at** (TIMESTAMP)

> **RÃ´le** : Liste des spÃ©cialitÃ©s mÃ©dicales.

### 10. Table `documents_rendez_vous`
- **id** (SERIAL, PK)
- **document_id** (INTEGER, FK â†’ document.id)
- **rendez_vous_id** (INTEGER, FK â†’ rendez_vous.id)
- **created_at** (TIMESTAMP)
- **UNIQUE** (document_id, rendez_vous_id)

> **RÃ´le** : Lien entre documents et rendez-vous.

### 11. Table `refresh_token`
- **id** (SERIAL, PK)
- **token** (VARCHAR, unique, not null)
- **utilisateur_id** (INTEGER, FK â†’ utilisateur.id)
- **expires_at** (TIMESTAMP, not null)
- **created_at** (TIMESTAMP)

> **RÃ´le** : Gestion des tokens de rafraÃ®chissement pour lâ€™authentification.

### 12. Enum `doc_role`
- **owner** : PropriÃ©taire du document (crÃ©ateur, patient ou mÃ©decin)
- **author** : MÃ©decin ayant uploadÃ© le document
- **shared** : AccÃ¨s partagÃ© (mÃ©decin consultÃ©)

---

### ğŸ”— **Relations clÃ©s**
- **Un patient** peut avoir plusieurs mÃ©decins suivis (via patient_doctor), et inversement.
- **Un document** appartient toujours Ã  un patient, peut Ãªtre uploadÃ© par un patient ou un mÃ©decin, et partagÃ© Ã  dâ€™autres via document_permission.
- **Les permissions** sont gÃ©rÃ©es par document_permissionâ€¯: chaque accÃ¨s est explicite et typÃ© (owner, author, shared).
- **Le suivi** est crÃ©Ã© automatiquement aprÃ¨s un RDV terminÃ© ou manuellement par le mÃ©decin.

---

### ğŸ›¡ï¸ **SÃ©curitÃ© et intÃ©gritÃ©**
- **ClÃ©s Ã©trangÃ¨res** avec suppression en cascade pour garantir la cohÃ©rence (exâ€¯: suppression dâ€™un patient supprime ses documents, permissions, liens de suivi).
- **Index** sur les colonnes critiques pour la performance (user_id, document_id, patient_id, doctor_id).
- **VÃ©rification des permissions** obligatoire avant tout accÃ¨s Ã  un document.

---

### ğŸ“ˆ **Ã‰volutivitÃ©**
- La structure permet dâ€™ajouter facilement de nouveaux rÃ´les, types de documents, ou niveaux de permission.
- Les tables de pivot (patient_doctor, document_permission) sont adaptÃ©es Ã  un modÃ¨le de partage granulaire et scalable. 